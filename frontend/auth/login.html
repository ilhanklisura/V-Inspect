<!DOCTYPE html>
<html lang="bs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prijava - VInspect</title>
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="auth-page">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">VInspect</h1>
          <p class="auth-subtitle">Prijavite se na vaš račun</p>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required />
          </div>

          <div class="form-group">
            <label for="password" class="form-label">Lozinka</label>
            <input
              type="password"
              id="password"
              class="form-control"
              required
            />
          </div>

          <div
            id="loginError"
            class="error-message mb-3"
            style="display: none; color: red"
          ></div>

          <button type="submit" class="btn btn-primary w-100">Prijava</button>
        </form>

        <div class="auth-footer">
          <p>
            Nemate račun?
            <a href="register.html" class="auth-link">Registrujte se</a>
          </p>
          <p><a href="../index.html" class="auth-link">Nazad na početnu</a></p>
        </div>
      </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const errorMsg = document.getElementById("loginError");

        // Provjeri već postojeći token
        const existingToken = localStorage.getItem("token");
        if (existingToken) {
          try {
            // Dohvati ulogu iz tokena
            const payload = JSON.parse(atob(existingToken.split(".")[1]));
            if (payload && payload.role) {
              redirectBasedOnRole(payload.role);
              return; // Prekini izvršavanje ako je korisnik već prijavljen
            }
          } catch (e) {
            console.log("Invalid token, continuing to login page");
            localStorage.removeItem("token"); // Ukloni neispravan token
          }
        }

        // Funkcija za preusmjeravanje na odgovarajući dashboard
        function redirectBasedOnRole(role) {
          switch (role) {
            case "admin":
              console.log("Redirecting to admin dashboard");
              window.location.href =
                "http://localhost:8888/V-Inspect/frontend/pages/admin/dashboard.html";
              break;
            case "vehicle_owner":
              console.log("Redirecting to vehicle owner dashboard");
              window.location.href =
                "http://localhost:8888/V-Inspect/frontend/pages/vehicle-owner/dashboard.html";
              break;
            case "inspection_staff":
              console.log("Redirecting to inspection staff dashboard");
              window.location.href =
                "http://localhost:8888/V-Inspect/frontend/pages/inspection-staff/dashboard.html";
              break;
            default:
              console.log("Unknown role, staying on login page");
          }
        }

        loginForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          // Očisti prethodne greške
          errorMsg.style.display = "none";

          try {
            // Hardkodirani korisnici za development
            if (email === "admin@example.com" && password === "admin123") {
              console.log("Admin hardcoded login");
              // Kreiraj fake token za administratora
              const payload = {
                user_id: 1,
                email: "admin@example.com",
                role: "admin",
                exp: Math.floor(Date.now() / 1000) + 86400, // 24h
              };

              const token = `fake.${btoa(JSON.stringify(payload))}.sig`;
              localStorage.setItem("token", token);

              redirectBasedOnRole("admin");
              return;
            }

            if (email === "staff@example.com" && password === "12345678") {
              console.log("Staff hardcoded login");
              // Kreiraj fake token za osoblje
              const payload = {
                user_id: 9,
                email: "staff@example.com",
                role: "inspection_staff",
                exp: Math.floor(Date.now() / 1000) + 86400, // 24h
              };

              const token = `fake.${btoa(JSON.stringify(payload))}.sig`;
              localStorage.setItem("token", token);

              redirectBasedOnRole("inspection_staff");
              return;
            }

            if (email === "owner@example.com" && password === "owner123") {
              console.log("Owner hardcoded login");
              // Kreiraj fake token za vlasnika
              const payload = {
                user_id: 2,
                email: "owner@example.com",
                role: "vehicle_owner",
                exp: Math.floor(Date.now() / 1000) + 86400, // 24h
              };

              const token = `fake.${btoa(JSON.stringify(payload))}.sig`;
              localStorage.setItem("token", token);

              redirectBasedOnRole("vehicle_owner");
              return;
            }

            // Pokušaj prijavu putem API-ja
            console.log("Attempting login via API");
            const response = await api.login(email, password);

            if (response && response.token) {
              console.log("Login successful via API");
              try {
                // Dohvati ulogu iz tokena
                const tokenParts = response.token.split(".");
                if (tokenParts.length >= 2) {
                  const payload = JSON.parse(atob(tokenParts[1]));
                  console.log("User role from token:", payload.role);

                  // Preusmjeri na odgovarajući dashboard
                  redirectBasedOnRole(payload.role);
                } else {
                  console.error("Invalid token format");
                  errorMsg.textContent =
                    "Greška prilikom prijave: Neispravan token";
                  errorMsg.style.display = "block";
                }
              } catch (error) {
                console.error("Error parsing token:", error);
                errorMsg.textContent =
                  "Greška prilikom prijave: Neispravan token";
                errorMsg.style.display = "block";
              }
            } else {
              console.error("Login failed: No token in response");
              errorMsg.textContent = "Pogrešan email ili lozinka";
              errorMsg.style.display = "block";
            }
          } catch (error) {
            console.error("Login error:", error);
            errorMsg.textContent = `Greška prilikom prijave: ${
              error.message || "Nepoznata greška"
            }`;
            errorMsg.style.display = "block";
          }
        });
      });
    </script>
  </body>
</html>
