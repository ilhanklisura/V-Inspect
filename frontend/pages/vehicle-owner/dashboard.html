<!DOCTYPE html>
<html lang="bs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - VInspect</title>
    <link rel="stylesheet" href="../../assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="main-header">
      <div class="container">
        <div class="header-content">
          <div class="logo">VInspect</div>
          <div class="user-info">
            <span class="user-name" id="userNameDisplay"></span>
            <button id="logout-btn" class="logout-btn">
              <i class="fas fa-sign-out-alt mr-1"></i> Odjava
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-container">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="dashboard.html" class="sidebar-link active">
              <i class="fas fa-tachometer-alt sidebar-icon"></i> Dashboard
            </a>
          </li>
          <li class="sidebar-item">
            <a href="vehicles.html" class="sidebar-link">
              <i class="fas fa-car sidebar-icon"></i> Moja vozila
            </a>
          </li>
          <li class="sidebar-item">
            <a href="inspections.html" class="sidebar-link">
              <i class="fas fa-clipboard-check sidebar-icon"></i> Tehnički
              pregledi
            </a>
          </li>
        </ul>
      </div>

      <div class="dashboard-content">
        <div class="page-header">
          <h1 class="page-title">Dobrodošli, <span id="userName"></span>!</h1>
          <p class="page-subtitle">Pregled vašeg VInspect računa</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Ukupno vozila</div>
            <div class="stat-value" id="totalVehicles">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Zakazani pregledi</div>
            <div class="stat-value" id="scheduledInspections">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Završeni pregledi</div>
            <div class="stat-value" id="completedInspections">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Nedavna vozila</h2>
            <a href="vehicles.html" class="btn btn-outline btn-sm">Vidi sve</a>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Proizvođač</th>
                  <th>Model</th>
                  <th>Godina</th>
                  <th>VIN</th>
                  <th>Akcije</th>
                </tr>
              </thead>
              <tbody id="recentVehiclesTable">
                <tr>
                  <td colspan="5" class="text-center">Učitavanje...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">
            <h2 class="card-title">Nedavni pregledi</h2>
            <a href="inspections.html" class="btn btn-outline btn-sm"
              >Vidi sve</a
            >
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Vozilo</th>
                  <th>Stanica</th>
                  <th>Datum</th>
                  <th>Status</th>
                  <th>Akcije</th>
                </tr>
              </thead>
              <tbody id="recentInspectionsTable">
                <tr>
                  <td colspan="5" class="text-center">Učitavanje...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script>
      // Initialize auth and check access
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize auth
        if (!api.isAuthenticated()) {
          auth.redirectToLogin();
          return;
        }

        const user = auth.loadUserFromToken();
        if (!user || user.role !== "vehicle_owner") {
          auth.redirectToDashboard();
          return;
        }

        // Display user name
        document.getElementById("userName").textContent = user.email;
        document.getElementById("userNameDisplay").textContent = user.email;

        // Load dashboard data
        await loadDashboardData();
      });

      async function loadDashboardData() {
        try {
          // Load vehicles
          const vehicles = await api.getMyVehicles();
          document.getElementById("totalVehicles").textContent =
            vehicles.length;

          // Load inspections
          const inspections = await api.getMyInspections();

          // Count scheduled and completed inspections
          const scheduled = inspections.filter(
            (inspection) => inspection.status === "scheduled"
          ).length;
          const completed = inspections.filter(
            (inspection) => inspection.status === "completed"
          ).length;

          document.getElementById("scheduledInspections").textContent =
            scheduled;
          document.getElementById("completedInspections").textContent =
            completed;

          // Display recent vehicles (max 5)
          const recentVehicles = vehicles.slice(0, 5);
          displayRecentVehicles(recentVehicles);

          // Display recent inspections (max 5)
          const recentInspections = inspections.slice(0, 5);
          displayRecentInspections(recentInspections, vehicles);
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showNotification("Greška prilikom učitavanja podataka", "error");
        }
      }

      function displayRecentVehicles(vehicles) {
        const tableBody = document.getElementById("recentVehiclesTable");

        if (vehicles.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center">Nema registrovanih vozila</td></tr>';
          return;
        }

        let html = "";
        vehicles.forEach((vehicle) => {
          html += `
                <tr>
                    <td>${vehicle.make}</td>
                    <td>${vehicle.model}</td>
                    <td>${vehicle.year}</td>
                    <td>${vehicle.vin}</td>
                    <td class="action-cell">
                        <a href="vehicles.html?id=${vehicle.id}" class="btn btn-primary btn-sm btn-action">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                `;
        });

        tableBody.innerHTML = html;
      }

      function displayRecentInspections(inspections, vehicles) {
        const tableBody = document.getElementById("recentInspectionsTable");

        if (inspections.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center">Nema zakazanih pregleda</td></tr>';
          return;
        }

        // We need to load the stations for station names
        api
          .getStations()
          .then((stations) => {
            const stationsMap = {};
            stations.forEach((station) => {
              stationsMap[station.id] = station;
            });

            // Create a map of vehicles for easier lookup
            const vehiclesMap = {};
            vehicles.forEach((vehicle) => {
              vehiclesMap[vehicle.id] = vehicle;
            });

            let html = "";
            inspections.forEach((inspection) => {
              const vehicle = vehiclesMap[inspection.vehicle_id] || {
                make: "Nepoznato",
                model: "Nepoznato",
              };
              const station = stationsMap[inspection.station_id] || {
                name: "Nepoznata stanica",
              };

              const statusClass =
                inspection.status === "scheduled"
                  ? "status-scheduled"
                  : inspection.status === "completed"
                  ? "status-completed"
                  : "status-failed";

              const statusText =
                inspection.status === "scheduled"
                  ? "Zakazan"
                  : inspection.status === "completed"
                  ? "Završen"
                  : "Nije prošao";

              const date = new Date(inspection.date).toLocaleDateString(
                "bs-BA"
              );

              html += `
                    <tr>
                        <td>${vehicle.make} ${vehicle.model}</td>
                        <td>${station.name}</td>
                        <td>${date}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-cell">
                            <a href="inspections.html?id=${inspection.id}" class="btn btn-primary btn-sm btn-action">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    `;
            });

            tableBody.innerHTML = html;
          })
          .catch((error) => {
            console.error("Error loading stations:", error);
            tableBody.innerHTML =
              '<tr><td colspan="5" class="text-center">Greška prilikom učitavanja pregleda</td></tr>';
          });
      }
    </script>
  </body>
</html>
