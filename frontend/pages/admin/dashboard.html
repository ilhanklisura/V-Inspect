<!DOCTYPE html>
<html lang="bs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - VInspect</title>
    <link rel="stylesheet" href="../../assets/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="main-header">
      <div class="container">
        <div class="header-content">
          <div class="logo">VInspect</div>
          <div class="user-info">
            <span class="user-name" id="userNameDisplay"></span>
            <button id="logout-btn" class="logout-btn">
              <i class="fas fa-sign-out-alt mr-1"></i> Odjava
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-container">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="dashboard.html" class="sidebar-link active">
              <i class="fas fa-tachometer-alt sidebar-icon"></i> Dashboard
            </a>
          </li>
          <li class="sidebar-item">
            <a href="users.html" class="sidebar-link">
              <i class="fas fa-users sidebar-icon"></i> Korisnici
            </a>
          </li>
          <li class="sidebar-item">
            <a href="vehicles.html" class="sidebar-link">
              <i class="fas fa-car sidebar-icon"></i> Vozila
            </a>
          </li>
          <li class="sidebar-item">
            <a href="stations.html" class="sidebar-link">
              <i class="fas fa-building sidebar-icon"></i> Stanice
            </a>
          </li>
          <li class="sidebar-item">
            <a href="inspections.html" class="sidebar-link">
              <i class="fas fa-clipboard-check sidebar-icon"></i> Pregledi
            </a>
          </li>
        </ul>
      </div>

      <div class="dashboard-content">
        <div class="page-header">
          <h1 class="page-title">Admin Dashboard</h1>
          <p class="page-subtitle">Pregled sistema VInspect</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Korisnici</div>
            <div class="stat-value" id="totalUsers">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Vozila</div>
            <div class="stat-value" id="totalVehicles">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Stanice</div>
            <div class="stat-value" id="totalStations">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pregledi</div>
            <div class="stat-value" id="totalInspections">0</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Korisnici po ulogama</h2>
              </div>
              <div class="card-body">
                <div class="chart-container" id="userRolesChart">
                  <canvas id="userRolesCanvas"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Status pregleda</h2>
              </div>
              <div class="card-body">
                <div class="chart-container" id="inspectionStatusChart">
                  <canvas id="inspectionStatusCanvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header">
            <h2 class="card-title">Nedavne aktivnosti</h2>
          </div>
          <div class="activity-feed" id="activityFeed">
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="activity-content">Učitavanje aktivnosti...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script>
      // Initialize auth and check access
      document.addEventListener("DOMContentLoaded", async function () {
        // Check if user is authenticated
        if (!api.isAuthenticated()) {
          auth.redirectToLogin();
          return;
        }

        const user = auth.loadUserFromToken();
        if (!user || user.role !== "admin") {
          auth.redirectToDashboard();
          return;
        }

        // Display user name
        document.getElementById("userNameDisplay").textContent = user.email;

        // Load dashboard data
        await loadDashboardData();
      });

      async function loadDashboardData() {
        try {
          // Load all data
          const [users, vehicles, stations, inspections] = await Promise.all([
            api.getUsers(),
            api.getVehicles(),
            api.getStations(),
            api.getInspections(),
          ]);

          // Update stats
          document.getElementById("totalUsers").textContent = users.length;
          document.getElementById("totalVehicles").textContent =
            vehicles.length;
          document.getElementById("totalStations").textContent =
            stations.length;
          document.getElementById("totalInspections").textContent =
            inspections.length;

          // Create charts
          createUserRolesChart(users);
          createInspectionStatusChart(inspections);

          // Create activity feed
          createActivityFeed(users, vehicles, inspections);
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showNotification("Greška prilikom učitavanja podataka", "error");
        }
      }

      function createUserRolesChart(users) {
        // Count users by role
        const roleCount = {
          admin: 0,
          vehicle_owner: 0,
          inspection_staff: 0,
        };

        users.forEach((user) => {
          if (roleCount.hasOwnProperty(user.role)) {
            roleCount[user.role]++;
          }
        });

        // Create chart
        const ctx = document.getElementById("userRolesCanvas").getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Administratori", "Vlasnici vozila", "Osoblje za pregled"],
            datasets: [
              {
                data: [
                  roleCount.admin,
                  roleCount.vehicle_owner,
                  roleCount.inspection_staff,
                ],
                backgroundColor: ["#1976d2", "#4caf50", "#ff9800"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function createInspectionStatusChart(inspections) {
        // Count inspections by status
        const statusCount = {
          scheduled: 0,
          completed: 0,
          failed: 0,
        };

        inspections.forEach((inspection) => {
          if (statusCount.hasOwnProperty(inspection.status)) {
            statusCount[inspection.status]++;
          }
        });

        // Create chart
        const ctx = document
          .getElementById("inspectionStatusCanvas")
          .getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Zakazani", "Završeni", "Nisu prošli"],
            datasets: [
              {
                data: [
                  statusCount.scheduled,
                  statusCount.completed,
                  statusCount.failed,
                ],
                backgroundColor: ["#ff9800", "#4caf50", "#f44336"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function createActivityFeed(users, vehicles, inspections) {
        const activityFeed = document.getElementById("activityFeed");

        // Create combined activity list (mock activities based on available data)
        const activities = [];

        // Add recent users
        users.slice(-3).forEach((user) => {
          activities.push({
            type: "user",
            message: `Novi korisnik registrovan: ${user.name}`,
            icon: "fas fa-user-plus",
            time: new Date().getTime() - Math.floor(Math.random() * 604800000), // Random time within last week
          });
        });

        // Add recent vehicles
        vehicles.slice(-3).forEach((vehicle) => {
          activities.push({
            type: "vehicle",
            message: `Novo vozilo dodano: ${vehicle.make} ${vehicle.model}`,
            icon: "fas fa-car",
            time: new Date().getTime() - Math.floor(Math.random() * 604800000),
          });
        });

        // Add recent inspections
        inspections.slice(-5).forEach((inspection) => {
          const vehicle = vehicles.find(
            (v) => v.id === inspection.vehicle_id
          ) || { make: "Nepoznato", model: "Nepoznato" };

          let message = "";
          let icon = "";

          if (inspection.status === "scheduled") {
            message = `Novi pregled zakazan za ${vehicle.make} ${vehicle.model}`;
            icon = "fas fa-calendar-plus";
          } else if (inspection.status === "completed") {
            message = `Pregled završen uspješno za ${vehicle.make} ${vehicle.model}`;
            icon = "fas fa-check-circle";
          } else if (inspection.status === "failed") {
            message = `Pregled nije prošao za ${vehicle.make} ${vehicle.model}`;
            icon = "fas fa-times-circle";
          }

          activities.push({
            type: "inspection",
            message,
            icon,
            time: new Date(inspection.date).getTime(),
          });
        });

        // Sort activities by time (newest first)
        activities.sort((a, b) => b.time - a.time);

        // Display up to 6 most recent activities
        const recentActivities = activities.slice(0, 6);

        if (recentActivities.length === 0) {
          activityFeed.innerHTML =
            '<div class="activity-item"><div class="activity-content">Nema nedavnih aktivnosti</div></div>';
          return;
        }

        let html = "";
        recentActivities.forEach((activity) => {
          const timeAgo = getTimeAgo(activity.time);

          html += `
                <div class="activity-item">
                    <div class="activity-icon"><i class="${activity.icon}"></i></div>
                    <div class="activity-content">
                        <div class="activity-message">${activity.message}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                </div>
                `;
        });

        activityFeed.innerHTML = html;
      }

      // Helper function to format time ago
      function getTimeAgo(timestamp) {
        const seconds = Math.floor((new Date().getTime() - timestamp) / 1000);

        let interval = Math.floor(seconds / 31536000);
        if (interval > 1) return `prije ${interval} godina`;
        if (interval === 1) return `prije 1 godinu`;

        interval = Math.floor(seconds / 2592000);
        if (interval > 1) return `prije ${interval} mjeseci`;
        if (interval === 1) return `prije 1 mjesec`;

        interval = Math.floor(seconds / 86400);
        if (interval > 1) return `prije ${interval} dana`;
        if (interval === 1) return `prije 1 dan`;

        interval = Math.floor(seconds / 3600);
        if (interval > 1) return `prije ${interval} sati`;
        if (interval === 1) return `prije 1 sat`;

        interval = Math.floor(seconds / 60);
        if (interval > 1) return `prije ${interval} minuta`;
        if (interval === 1) return `prije 1 minutu`;

        if (seconds < 10) return "upravo sada";

        return `prije ${Math.floor(seconds)} sekundi`;
      }
    </script>
  </body>
</html>
